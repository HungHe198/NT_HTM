@model NT.SHARED.Models.Order

@{
    ViewData["Title"] = "In hóa đơn";
    var details = ViewBag.Details as List<NT.SHARED.Models.OrderDetail> ?? new();
    var orderCode = ViewBag.OrderCode ?? $"POS-{Model.Id.ToString().Substring(0, 8).ToUpper()}";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Success Alert -->
            <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
                <i class="fas fa-check-circle fa-2x me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Đơn hàng đã được tạo thành công!</h5>
                    <p class="mb-0">Mã đơn: <strong>@orderCode</strong></p>
                </div>
            </div>

            <!-- Receipt -->
            <div class="card shadow" id="receipt">
                <div class="card-body p-4">
                    <!-- Header -->
                    <div class="text-center mb-4">
                        <h3 class="fw-bold mb-1">HÓA ĐƠN BÁN HÀNG</h3>
                        <p class="text-muted small mb-0">POS - Bán hàng tại quầy</p>
                        <hr class="my-3">
                    </div>

                    <!-- Order Info -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <p class="mb-1"><strong>Mã đơn:</strong> <code class="fs-6">@orderCode</code></p>
                            <p class="mb-1"><strong>Ngày:</strong> @Model.CreatedTime.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</p>
                            <p class="mb-1"><strong>Trạng thái:</strong> <span class="badge bg-success">Hoàn thành</span></p>
                        </div>
                        <div class="col-6 text-end">
                            <p class="mb-1"><strong>Khách hàng:</strong> @(Model.Customer?.User?.Fullname ?? "Khách lẻ")</p>
                            <p class="mb-1"><strong>SĐT:</strong> @(Model.PhoneNumber ?? "N/A")</p>
                            <p class="mb-1"><strong>Địa chỉ:</strong> @(string.IsNullOrWhiteSpace(Model.ShippingAddress) ? "Bán tại quầy" : Model.ShippingAddress)</p>
                        </div>
                    </div>

                    <hr>

                    <!-- Items Table -->
                    <div class="table-responsive mb-3">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 35%;">Sản phẩm</th>
                                    <th style="width: 25%;">Phân loại</th>
                                    <th class="text-end" style="width: 15%;">Đơn giá</th>
                                    <th class="text-center" style="width: 5%;">SL</th>
                                    <th class="text-end" style="width: 15%;">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int index = 1;
                                    foreach (var detail in details)
                                    {
                                        <tr>
                                            <td>@index</td>
                                            <td>
                                                <strong>@(detail.NameAtOrder ?? "N/A")</strong>
                                                @if(!string.IsNullOrWhiteSpace(detail.ProductCodeAtOrder))
                                                {
                                                    <div><small class="text-muted">Mã: <code>@detail.ProductCodeAtOrder</code></small></div>
                                                }
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    @{
                                                        var variants = new List<string>();
                                                        if (!string.IsNullOrWhiteSpace(detail.LengthAtOrder)) variants.Add(detail.LengthAtOrder);
                                                        if (!string.IsNullOrWhiteSpace(detail.HardnessAtOrder)) variants.Add(detail.HardnessAtOrder);
                                                        if (!string.IsNullOrWhiteSpace(detail.ColorAtOrder)) variants.Add(detail.ColorAtOrder);
                                                    }
                                                    @(variants.Any() ? string.Join(" / ", variants) : "-")
                                                </small>
                                            </td>
                                            <td class="text-end">@detail.UnitPrice.ToString("#,##0")₫</td>
                                            <td class="text-center">@detail.Quantity</td>
                                            <td class="text-end"><strong>@detail.TotalPrice.ToString("#,##0")₫</strong></td>
                                        </tr>
                                        index++;
                                    }
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    <div class="border-top pt-3">
                        <div class="row mb-2">
                            <div class="col-8 text-end">Tổng tiền hàng:</div>
                            <div class="col-4 text-end"><strong>@Model.TotalAmount.ToString("#,##0")₫</strong></div>
                        </div>

                        @if (Model.DiscountAmount.HasValue && Model.DiscountAmount > 0)
                        {
                            <div class="row mb-2 text-danger">
                                <div class="col-8 text-end">Giảm giá:</div>
                                <div class="col-4 text-end"><strong>-@Model.DiscountAmount.Value.ToString("#,##0")₫</strong></div>
                            </div>
                        }

                        <div class="row py-2 bg-light rounded">
                            <div class="col-8 text-end fs-5 fw-bold">THÀNH TIỀN:</div>
                            <div class="col-4 text-end fs-5 fw-bold text-danger">@Model.FinalAmount.ToString("#,##0")₫</div>
                        </div>
                    </div>

                    <!-- Payment & Note -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>Phương thức TT:</strong> @(Model.PaymentMethod?.Name ?? "Tiền mặt")</p>
                            </div>
                            <div class="col-6 text-end">
                                <p class="mb-1"><strong>Nhân viên:</strong> POS Staff</p>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.Note))
                        {
                            <div class="alert alert-light mt-2 mb-0 py-2">
                                <i class="fas fa-sticky-note me-1"></i> <strong>Ghi chú:</strong> @Model.Note
                            </div>
                        }
                    </div>

                    <!-- Footer -->
                    <div class="text-center mt-4 pt-3 border-top">
                        <p class="mb-1"><i class="fas fa-heart text-danger"></i> Cảm ơn quý khách!</p>
                        <p class="small text-muted mb-0">Mọi thắc mắc vui lòng liên hệ: <strong>0901 234 567</strong></p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2 mt-4 mb-4">
                <button class="btn btn-primary btn-lg flex-grow-1" onclick="printReceipt()">
                    <i class="fas fa-print me-1"></i> In hóa đơn
                </button>
                <a href="@Url.Action("Index", "Sales")" class="btn btn-success btn-lg flex-grow-1">
                    <i class="fas fa-cash-register me-1"></i> Tiếp tục bán hàng
                </a>
                <a href="@Url.Action("History", "Sales")" class="btn btn-info btn-lg flex-grow-1">
                    <i class="fas fa-history me-1"></i> Lịch sử
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    @@media print {
        .btn, .alert-success, nav, .sidebar, header, footer {
            display: none !important;
        }
        #receipt {
            box-shadow: none !important;
            border: none !important;
        }
    }
</style>

@section Scripts {
<script>
    function printReceipt() {
        window.print();
    }

    // Auto-focus on Print button
    window.addEventListener('load', () => {
        document.querySelector('.btn-primary').focus();
    });
</script>
}
