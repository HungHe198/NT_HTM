@model IEnumerable<NT.SHARED.Models.Customer>

@{
    ViewBag.Title = "Quản lý khách hàng";
}

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- LEFT SIDEBAR MENU -->
        <aside class="col-xl-2 col-lg-3">
       <div class="card shadow-sm sticky-top" style="top: 20px;">
      <div class="card-body">
   <a asp-controller="Home" asp-action="Index" class="d-block mb-3">
     <img src="/images/logo.png" alt="Logo" style="height: 36px;">
           </a>

    <div class="mb-3 pb-3 border-bottom">
         <div class="fw-bold small">Quản lý khách hàng</div>
        </div>

            <nav class="nav flex-column gap-1">
       <a asp-controller="Admin" asp-action="Index" class="nav-link nav-link-primary fw-500">
         <i class="bi bi-collection me-2"></i>Danh Mục
    </a>
  <a asp-controller="Product" asp-action="Index" class="nav-link nav-link-primary fw-500">
       <i class="bi bi-box me-2"></i>Sản Phẩm
         </a>
      <a asp-controller="Customer" asp-action="Index" class="nav-link nav-link-primary fw-500 active" style="color: #0d6efd; background-color: rgba(13, 110, 253, 0.1); border-radius: 6px;">
    <i class="bi bi-people me-2"></i>Khách Hàng
                </a>
          <a asp-controller="Orders" asp-action="Index" class="nav-link nav-link-primary fw-500">
          <i class="bi bi-bag me-2"></i>Đơn Hàng
                 </a>
           </nav>
                </div>
       </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="col-xl-10 col-lg-9">
            <!-- HEADER -->
     <div class="mb-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
     <div>
     <h1 class="h3 mb-0">Quản lý Khách hàng</h1>
          <p class="text-muted small mb-0">Tổng: <strong>@(Model?.Count() ?? 0)</strong> khách hàng</p>
            </div>
       <a asp-action="Create" class="btn btn-primary btn-lg fw-bold">
  <i class="bi bi-plus-circle"></i> Thêm khách hàng mới
        </a>
     </div>
</div>

            <!-- SEARCH & FILTER -->
            <div class="card shadow-sm mb-4 border-0">
     <div class="card-body">
        <form method="get" asp-action="Index" class="position-relative">
     <div class="input-group input-group-lg">
       <input type="text"
 id="customer-search"
            name="q"
                  value=""
       class="form-control"
     placeholder="Tìm kiếm theo tên, email, số điện thoại..."
    autocomplete="off" />
      <button type="submit" class="btn btn-outline-secondary fw-bold">
      <i class="bi bi-search"></i> Tìm kiếm
    </button>
     </div>

              <!-- Suggestions Dropdown -->
       <div id="suggestions" class="list-group position-absolute"
          style="z-index: 1000; width: 100%; left: 0; top: 52px; display: none; max-height: 400px; overflow-y: auto;">
    </div>
    </form>
         </div>
            </div>

            <!-- CUSTOMERS TABLE -->
            <div class="card shadow-sm border-0">
     <div class="card-header bg-light d-flex align-items-center justify-content-between">
     <h5 class="mb-0">Danh sách Khách hàng <span class="badge bg-secondary">@(Model?.Count() ?? 0)</span></h5>
</div>
     <div class="card-body p-0">
    @if (!(Model?.Any() ?? false))
            {
         <div class="text-center py-5 text-muted">
             <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
        <p class="mt-3">Chưa có khách hàng</p>
    </div>
           }
        else
    {
      <div class="table-responsive">
 <table class="table table-hover align-middle mb-0">
 <thead class="table-light">
          <tr>
            <th style="width: 25%;">Tên Khách hàng</th>
       <th style="width: 20%;">Email</th>
          <th style="width: 15%;">Số Điện thoại</th>
         <th style="width: 15%;">Ngày Sinh</th>
      <th style="width: 10%;">Giới Tính</th>
          <th style="width: 15%;">Hành động</th>
                 </tr>
                 </thead>
           <tbody id="customersTableBody">
 @foreach (var customer in Model)
         {
     <tr class="customer-row" data-customer-id="@customer.Id">
  <td class="fw-semibold">
     @(customer.User?.Fullname ?? "N/A")
 </td>
      <td class="text-muted small">
     @(customer.User?.Email ?? "N/A")
     </td>
 <td>
@(customer.User?.PhoneNumber ?? "N/A")
     </td>
          <td>
           @if (customer.DoB.HasValue)
    {
        <span>@customer.DoB.Value.ToString("dd/MM/yyyy")</span>
       }
    else
            {
          <span class="text-muted">-</span>
       }
  </td>
           <td>
    @if (!string.IsNullOrWhiteSpace(customer.Gender))
          {
          <span class="badge bg-info">@customer.Gender</span>
           }
    else
      {
       <span class="text-muted">-</span>
         }
 </td>
      <td>
       <div class="btn-group btn-group-sm" role="group">
     <a asp-action="Details" asp-route-id="@customer.Id" class="btn btn-outline-info" title="Xem chi tiết">
  <i class="bi bi-eye"></i> Chi tiết
     </a>
  <a asp-action="Edit" asp-route-id="@customer.Id" class="btn btn-outline-primary" title="Chỉnh sửa">
            <i class="bi bi-pencil"></i> Sửa
      </a>
<button class="btn btn-outline-danger" type="button"
       data-bs-toggle="modal" data-bs-target="#deleteModal-@customer.Id" title="Xóa">
       <i class="bi bi-trash"></i> Xóa
    </button>
      </div>
    </td>
      </tr>

                <!-- Delete Modal -->
        <div class="modal fade" id="deleteModal-@customer.Id" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
             <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Xác nhận xóa</h5>
  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      <div class="modal-body">
       <p>Bạn có chắc muốn xóa khách hàng <strong>@(customer.User?.Fullname ?? "N/A")</strong>?</p>
   <p class="text-muted small">Email: <strong>@(customer.User?.Email ?? "N/A")</strong></p>
    </div>
              <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
       <a asp-action="Delete" asp-route-id="@customer.Id" class="btn btn-danger">Xóa</a>
    </div>
          </div>
               </div>
          </div>
   }
   </tbody>
       </table>
     </div>
       }
       </div>
   </div>
        </main>
    </div>
</div>

<style>
  .nav-link-primary {
        color: #495057;
        transition: all 0.2s ease;
    }

    .nav-link-primary:hover,
    .nav-link-primary.active {
      color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.1);
    border-radius: 6px;
    }
</style>

@section Scripts {
    <script>
        (function () {
          const input = document.getElementById('customer-search');
            const box = document.getElementById('suggestions');
            let timer = null;

     function hide() {
      box.style.display = 'none';
       box.innerHTML = '';
            }

            function show(items) {
       if (!items || items.length === 0) {
           hide();
             return;
                }
 box.innerHTML = items.map(i => `
            <a href="/Customer/Details/${i.id}" class="list-group-item list-group-item-action d-flex align-items-center gap-2 border-0 py-2">
   <div class="flex-grow-1 min-width-0">
  <div class="fw-semibold small">${i.fullname || 'N/A'}</div>
    <div class="small text-muted">${i.email || 'N/A'} | ${i.phoneNumber || 'N/A'}</div>
        </div>
    </a>
    `).join('');
                box.style.display = 'block';
      }

          input.addEventListener('input', function () {
         const q = this.value.trim();
          if (timer) clearTimeout(timer);
    if (q.length < 1) {
         hide();
     return;
  }
                timer = setTimeout(async () => {
        try {
           const res = await fetch(`/Customer/Suggest?q=${encodeURIComponent(q)}`);
         if (!res.ok) {
 hide();
                 return;
       }
   const data = await res.json();
  show(data);
       } catch (e) {
     hide();
           }
        }, 250);
    });

         // close when clicking outside
  document.addEventListener('click', function (e) {
   if (!box.contains(e.target) && e.target !== input) hide();
            });
        })();
    </script>
}
