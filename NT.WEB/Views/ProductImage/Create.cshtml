@model NT.SHARED.Models.ProductImage

@{
    ViewBag.Title = "Thêm ảnh sản phẩm";
}

<h1>Thêm ảnh sản phẩm</h1>

<form asp-action="Create" method="post" enctype="multipart/form-data" id="img-form">
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="form-group mb-3">
        <label asp-for="ProductDetailId">Biến thể sản phẩm</label>
        <input asp-for="ProductDetailId" class="form-control" />
        <span asp-validation-for="ProductDetailId" class="text-danger"></span>
    </div>

    <div class="form-group mb-3">
        <label class="form-label">Chọn ảnh tải lên</label>
        <input type="file" id="file" name="file" class="form-control" accept="image/*" />
        <div class="mt-2">
            <img id="preview" src="" alt="preview" style="max-height:160px; display:none; object-fit:contain;" />
        </div>
        <small class="form-text text-muted">Ảnh sẽ được tải lên thư mục wwwroot/uploads/products và hệ thống sẽ lưu đường dẫn truy cập web.</small>
    </div>

    <!-- Đường dẫn ảnh được điền tự động sau khi upload thành công -->
    <input asp-for="ImageUrl" type="hidden" />
    <span asp-validation-for="ImageUrl" class="text-danger"></span>

    <button type="submit" class="btn btn-primary">Lưu</button>
    <a asp-action="Index" class="btn btn-secondary">Hủy</a>
</form>

<script>
    (function(){
        const fileInput = document.getElementById('file');
        const preview = document.getElementById('preview');
        const form = document.getElementById('img-form');
        const imageUrlInput = document.getElementById('ImageUrl');

        fileInput.addEventListener('change', async function(){
            const f = this.files && this.files[0];
            if(!f) return;
            // preview
            const url = URL.createObjectURL(f);
            preview.src = url; preview.style.display = 'inline-block';

            const data = new FormData();
            data.append('file', f);
            try{
                const res = await fetch('/ProductImage/Upload', { method:'POST', body:data });
                if(!res.ok){ alert('Tải ảnh thất bại'); return; }
                const json = await res.json();
                imageUrlInput.value = json.url || '';
            }catch{
                alert('Có lỗi khi tải ảnh');
            }
        });

        form.addEventListener('submit', function(e){
            if(!imageUrlInput.value){
                e.preventDefault();
                alert('Vui lòng chọn và tải ảnh trước khi lưu');
            }
        });
    })();
</script>

