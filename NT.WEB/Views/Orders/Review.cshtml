@model NT.SHARED.Models.Order
@{
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("Employee");
    Layout = isAdmin ? "~/Views/Shared/_AdminLayout.cshtml" : "~/Views/Shared/_ClientLayout.cshtml";
    var details = ViewBag.Details as IEnumerable<NT.SHARED.Models.OrderDetail> ?? Enumerable.Empty<NT.SHARED.Models.OrderDetail>();
    var status = Model.Status ?? "0";       
}

<h2>Chi tiết đơn hàng</h2>
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@* Show cancel reason only for Admin/Employee when the order is canceled *@
@if (isAdmin && status == "-1")
{
    <div class="alert alert-danger">
       
        @if (!string.IsNullOrWhiteSpace(Model?.Note))
        {
            <div class="mt-2"><strong>Lý do hủy:</strong> @Model.Note</div>
        }
    </div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<div class="mb-2">Mã đơn: @Model.Id</div>
<div class="mb-2">Trạng thái: @(ViewBag.StatusText as string ?? Model.Status)</div>
<div class="mb-2">Tổng tiền: @Model.TotalAmount.ToString("#,##0")</div>
<div class="mb-2">Số tiền phải trả: @Model.FinalAmount.ToString("#,##0")</div>
<div class="mb-2">Số điện thoại: @Model.PhoneNumber</div>
<div class="mb-2">Địa chỉ: @Model.ShippingAddress</div>

<h5>Sản phẩm</h5>
<table class="table">
    <thead>
        <tr>
            <th>Tên</th>
            <th>Thuộc tính</th>
            <th>Số lượng</th>
            <th>Đơn giá</th>
            <th>Tổng</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var d in details)
    {
        <tr>
            <td>@(d.NameAtOrder ?? d.ProductDetail?.Product?.Name)</td>
            <td><small>Chiều dài: @(d.LengthAtOrder ?? d.ProductDetail?.Length?.Name), Độ cứng: @(d.HardnessAtOrder ?? d.ProductDetail?.Hardness?.Name),/*  Màu: @(d.ColorAtOrder ?? d.ProductDetail?.Color?.Name) */</small></td>
            <td>@d.Quantity</td>
            <td>@d.UnitPrice.ToString("#,##0")</td>
            <td>@((d.UnitPrice * d.Quantity).ToString("#,##0"))</td>
        </tr>
    }
    </tbody>
</table>

@if (User.IsInRole("Admin") || User.IsInRole("Employee"))
{
    <h5>Cập nhật trạng thái</h5>
    <div class="mt-2 d-flex flex-wrap gap-2">
        @* Adjacent transitions for admin/employee *@
        @if (status == "0")
        {
            <form asp-action="UpdateStatus" asp-controller="Orders" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="status" value="1" />
                <button class="btn btn-success" type="submit">Xác nhận đơn (lên 1)</button>
            </form>
            <form asp-action="Cancel" asp-controller="Orders" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="text" name="note" class="form-control" placeholder="Lý do hủy đơn" required />
                <button class="btn btn-danger" type="submit">Hủy đơn </button>
            </form>
        }
        else if (status == "1")
        {
            <form asp-action="UpdateStatus" asp-controller="Orders" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="status" value="2" />
                <button class="btn btn-warning" type="submit">Đưa vào vận chuyển </button>
            </form>
            <form asp-action="Cancel" asp-controller="Orders" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="text" name="note" class="form-control" placeholder="Lý do hủy đơn" required />
                <button class="btn btn-danger" type="submit">Hủy đơn </button>
            </form>
        }
        else if (status == "2")
        {
            <form asp-action="UpdateStatus" asp-controller="Orders" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="status" value="3" />
                <button class="btn btn-info" type="submit">Đánh dấu giao thành công </button>
            </form>
            <form asp-action="Cancel" asp-controller="Orders" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="text" name="note" class="form-control" placeholder="Lý do hủy đơn" required />
                <button class="btn btn-outline-danger" type="submit">Hủy đơn </button>
            </form>
        }
        else if (status == "3")
        {
            @* No cancel allowed in status 3 *@
        }
    </div>
}

@* Customer cancel: hide when status is 2 or 3 *@
@if (!(User.IsInRole("Admin") || User.IsInRole("Employee")))
{
    if (status != "2" && status != "3" && status != "-1")
    {
        <h5>Hủy đơn</h5>
        <form asp-action="Cancel" asp-controller="Orders" method="post" class="d-flex gap-2">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Id" />
            <input type="text" name="note" class="form-control" placeholder="Lý do hủy đơn" required />
            <button class="btn btn-danger" type="submit">Hủy đơn</button>
        </form>
    }
}
