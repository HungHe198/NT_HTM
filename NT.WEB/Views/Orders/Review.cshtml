@model NT.SHARED.Models.Order
@using NT.SHARED.Helpers
@{
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("Employee");
    Layout = isAdmin ? "~/Views/Shared/_AdminLayout.cshtml" : "~/Views/Shared/_ClientLayout.cshtml";
    var details = ViewBag.Details as IEnumerable<NT.SHARED.Models.OrderDetail> ?? Enumerable.Empty<NT.SHARED.Models.OrderDetail>();
    var status = Model.Status ?? "0";
    
    // Status helper
    string statusText, statusBadge;
    switch (status)
    {
        case "-1": statusText = "ƒê√£ h·ªßy"; statusBadge = "bg-danger"; break;
        case "0": statusText = "Ch·ªù x√°c nh·∫≠n"; statusBadge = "bg-warning text-dark"; break;
        case "1": statusText = "ƒê√£ x√°c nh·∫≠n"; statusBadge = "bg-info text-dark"; break;
        case "2": statusText = "ƒêang giao h√†ng"; statusBadge = "bg-primary"; break;
  case "3": statusText = "Giao th√†nh c√¥ng"; statusBadge = "bg-success"; break;
        default: statusText = "Kh√¥ng r√µ"; statusBadge = "bg-secondary"; break;
    }
    
    var utc = DateTime.SpecifyKind(Model.CreatedTime, DateTimeKind.Utc);
    DateTime gmt7;
    try { gmt7 = TimeZoneInfo.ConvertTimeFromUtc(utc, TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time")); }
    catch { gmt7 = utc.ToLocalTime(); }
    
    // T·∫°o m√£ ƒë∆°n h√†ng ng·∫Øn g·ªçn
    var orderCode = OrderCodeHelper.ToShortCode(Model.Id);
}

<div class="container py-4">
    @* Alert messages *@
    @if (TempData["Error"] != null)
    {
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
 @TempData["Error"]
     <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
  }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    
    <div class="row mb-4">
        <div class="col-lg-8">
  <!-- Order Header Card -->
     <div class="card shadow-sm mb-3">
           <div class="card-header bg-light d-flex align-items-center justify-content-between">
         <div>
    <h4 class="mb-0">Chi ti·∫øt ƒë∆°n h√†ng</h4>
   <small class="text-muted">M√£ ƒë∆°n: <strong class="text-primary">@orderCode</strong></small>
   @if (isAdmin)
   {
       <br/><small class="text-muted" style="font-size: 0.7rem;">ID: @Model.Id</small>
   }
        </div>
      <span class="badge @statusBadge" style="font-size: 0.9rem; padding: 0.5rem 0.8rem;">@statusText</span>
            </div>
    
          <div class="card-body">
            <div class="row mb-3">
    <div class="col-md-6">
           <label class="text-muted small">Ng√†y ƒë·∫∑t ƒë∆°n</label>
             <div class="fw-semibold">@gmt7.ToString("dd/MM/yyyy HH:mm")</div>
   </div>
             <div class="col-md-6">
    <label class="text-muted small">S·ªë ƒëi·ªán tho·∫°i</label>
     <div class="fw-semibold">@Model.PhoneNumber</div>
  </div>
     </div>
         <div class="row">
    <div class="col-12">
         <label class="text-muted small">ƒê·ªãa ch·ªâ giao h√†ng</label>
       <div class="fw-semibold">@Model.ShippingAddress</div>
            </div>
   </div>
     </div>
    </div>

       <!-- Cancel Reason (visible to admin and customer when ƒë√£ h·ªßy) -->
            @if (status == "-1" && !string.IsNullOrWhiteSpace(Model?.Note))
     {
    <div class="alert alert-danger mb-3" role="alert">
<h6 class="alert-heading mb-2">L√Ω do h·ªßy ƒë∆°n</h6>
         <p class="mb-0">@Model.Note</p>
          </div>
            }

      <!-- Products Card -->
            <div class="card shadow-sm mb-3">
       <div class="card-header bg-light">
   <h5 class="mb-0">S·∫£n ph·∫©m trong ƒë∆°n h√†ng</h5>
     </div>
         <div class="card-body p-0">
             <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
     <tr>
 <th style="width: 40%;">T√™n s·∫£n ph·∫©m</th>
        <th style="width: 25%;">Thu·ªôc t√≠nh</th>
            <th style="width: 12%; text-align: center;">S·ªë l∆∞·ª£ng</th>
  <th style="width: 12%; text-align: right;">ƒê∆°n gi√°</th>
           <th style="width: 15%; text-align: right;">T·ªïng c·ªông</th>
       </tr>
        </thead>
<tbody>
        @foreach (var d in details)
  {
        <tr>
      <td class="fw-semibold">@(d.NameAtOrder ?? d.ProductDetail?.Product?.Name ?? "N/A")</td>
        <td>
     <small class="text-muted">
                @if (!string.IsNullOrWhiteSpace(d.LengthAtOrder ?? d.ProductDetail?.Length?.Name))
     {
  <div>Chi·ªÅu d√†i: @(d.LengthAtOrder ?? d.ProductDetail?.Length?.Name)</div>
          }
         @if (!string.IsNullOrWhiteSpace(d.HardnessAtOrder ?? d.ProductDetail?.Hardness?.Name))
             {
    <div>ƒê·ªô c·ª©ng: @(d.HardnessAtOrder ?? d.ProductDetail?.Hardness?.Name)</div>
       }
    </small>
        </td>
            <td style="text-align: center;">@d.Quantity</td>
                 <td style="text-align: right;">@d.UnitPrice.ToString("#,##0")</td>
                  <td style="text-align: right;" class="fw-semibold">@((d.UnitPrice * d.Quantity).ToString("#,##0"))</td>
          </tr>
   }
          </tbody>
            </table>
        </div>
           </div>
            </div>
        </div>

        <!-- Summary Sidebar -->
      <div class="col-lg-4">
            <!-- Summary Card -->
  <div class="card shadow-sm mb-3 sticky-top" style="top: 20px;">
    <div class="card-header bg-light">
             <h5 class="mb-0">T√≥m t·∫Øt thanh to√°n</h5>
          </div>
         <div class="card-body">
  <div class="d-flex justify-content-between mb-2">
             <span class="text-muted">T·ªïng ti·ªÅn h√†ng:</span>
        <span>@Model.TotalAmount.ToString("#,##0")</span>
   </div>
     <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
     <span class="text-muted">Chi·∫øt kh·∫•u:</span>
      <span class="text-danger">-@((Model.TotalAmount - Model.FinalAmount).ToString("#,##0"))</span>
         </div>
  <div class="d-flex justify-content-between align-items-center">
       <span class="fw-semibold">S·ªë ti·ªÅn ph·∫£i tr·∫£:</span>
              <span class="fw-semibold" style="font-size: 1.3rem; color: #28a745;">@Model.FinalAmount.ToString("#,##0")</span>
    </div>
 </div>
     </div>

    <!-- Status Timeline -->
          <div class="card shadow-sm">
        <div class="card-header bg-light">
   <h5 class="mb-0">Ti·∫øn tr√¨nh ƒë∆°n h√†ng</h5>
          </div>
    <div class="card-body">
      <div class="timeline">
          <div class="timeline-item @(status == "-1" ? "active" : (int.Parse(status ?? "0") >= -1 ? "completed" : ""))">
           <div class="timeline-marker bg-danger"></div>
                  <div class="timeline-content">ƒê√£ h·ªßy</div>
        </div>
     <div class="timeline-item @(status == "0" ? "active" : (int.Parse(status ?? "0") >= 0 && status != "-1" ? "completed" : ""))">
       <div class="timeline-marker bg-warning"></div>
      <div class="timeline-content">Ch·ªù x√°c nh·∫≠n</div>
            </div>
          <div class="timeline-item @(status == "1" ? "active" : (int.Parse(status ?? "0") >= 1 && status != "-1" ? "completed" : ""))">
            <div class="timeline-marker bg-info"></div>
 <div class="timeline-content">ƒê√£ x√°c nh·∫≠n</div>
             </div>
            <div class="timeline-item @(status == "2" ? "active" : (int.Parse(status ?? "0") >= 2 && status != "-1" ? "completed" : ""))">
     <div class="timeline-marker bg-primary"></div>
    <div class="timeline-content">ƒêang giao</div>
 </div>
         <div class="timeline-item @(status == "3" ? "active" : (int.Parse(status ?? "0") >= 3 && status != "-1" ? "completed" : ""))">
    <div class="timeline-marker bg-success"></div>
  <div class="timeline-content">Giao th√†nh c√¥ng</div>
    </div>
     </div>
         </div>
 </div>
        </div>
    </div>

    <!-- Admin Actions -->
    @if (isAdmin && status != "-1" && status != "3")
    {
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
   <h5 class="mb-0">Qu·∫£n l√Ω ƒë∆°n h√†ng</h5>
            </div>
            <div class="card-body">
           <div class="row g-2">
  @if (status == "0")
  {
       <div class="col-sm-6 col-md-4">
           <form asp-action="UpdateStatus" asp-controller="Orders" method="post" class="w-100">
   @Html.AntiForgeryToken()
    <input type="hidden" name="id" value="@Model.Id" />
    <input type="hidden" name="status" value="1" />
              <button class="btn btn-success w-100" type="submit">‚úì X√°c nh·∫≠n ƒë∆°n</button>
         </form>
       </div>
                <div class="col-sm-6 col-md-4">
       <button class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#cancelModal">‚úï H·ªßy ƒë∆°n</button>
      </div>
         }
          else if (status == "1")
        {
                <div class="col-sm-6 col-md-4">
       <form asp-action="UpdateStatus" asp-controller="Orders" method="post" class="w-100">
@Html.AntiForgeryToken()
      <input type="hidden" name="id" value="@Model.Id" />
   <input type="hidden" name="status" value="2" />
       <button class="btn btn-warning w-100" type="submit">üì¶ ƒê∆∞a v√†o v·∫≠n chuy·ªÉn</button>
         </form>
  </div>
          <div class="col-sm-6 col-md-4">
                <button class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#cancelModal">‚úï H·ªßy ƒë∆°n</button>
</div>
         }
          else if (status == "2")
    {
     <div class="col-sm-6 col-md-4">
   <form asp-action="UpdateStatus" asp-controller="Orders" method="post" class="w-100">
          @Html.AntiForgeryToken()
     <input type="hidden" name="id" value="@Model.Id" />
   <input type="hidden" name="status" value="3" />
        <button class="btn btn-info w-100" type="submit">‚úì Giao th√†nh c√¥ng</button>
    </form>
         </div>
   <div class="col-sm-6 col-md-4">
          <button class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#cancelModal">‚úï H·ªßy ƒë∆°n</button>
  </div>
        }
    </div>
            </div>
        </div>
    }

    <!-- Customer Cancel Section -->
    @if (!isAdmin && status != "2" && status != "3" && status != "-1")
    {
        <div class="card shadow-sm">
  <div class="card-header bg-light">
           <h5 class="mb-0">H·ªßy ƒë∆°n h√†ng</h5>
            </div>
 <div class="card-body">
    <p class="text-muted mb-3">B·∫°n c√≥ th·ªÉ h·ªßy ƒë∆°n h√†ng n√†y. Vui l√≤ng ch·ªçn l√Ω do h·ªßy:</p>
          <form asp-action="Cancel" asp-controller="Orders" method="post">
 @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
        <div class="list-group mb-3">
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="note" value="T√¥i mu·ªën thay ƒë·ªïi s·∫£n ph·∫©m (k√≠ch th∆∞·ªõc, m√†u s·∫Øc, s·ªë l∆∞·ª£ng,...)" required>
                T√¥i mu·ªën thay ƒë·ªïi s·∫£n ph·∫©m (k√≠ch th∆∞·ªõc, m√†u s·∫Øc, s·ªë l∆∞·ª£ng,...)
            </label>
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="note" value="T√¥i mu·ªën c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ/sƒët nh·∫≠n h√†ng" required>
                T√¥i mu·ªën c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ/sƒët nh·∫≠n h√†ng
            </label>
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="note" value="T√¥i kh√¥ng c√≥ nhu c·∫ßu mua n·ªØa" required>
                T√¥i kh√¥ng c√≥ nhu c·∫ßu mua n·ªØa
            </label>
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="note" value="Ng∆∞·ªùi b√°n x√°c nh·∫≠n g·ª≠i sai h√†ng" required>
                Ng∆∞·ªùi b√°n x√°c nh·∫≠n g·ª≠i sai h√†ng
            </label>
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="note" value="Ng∆∞·ªùi b√°n x√°c nh·∫≠n m·∫•t h√†ng, h·ªèng h√†ng" required>
                Ng∆∞·ªùi b√°n x√°c nh·∫≠n m·∫•t h√†ng, h·ªèng h√†ng
            </label>
            <label class="list-group-item">
                <input class="form-check-input me-2" type="radio" name="note" value="__OTHER__" required id="reasonOtherRadio">
                Kh√°c
            </label>
        </div>
        <div class="mb-3" id="reasonOtherBox" style="display:none;">
            <textarea class="form-control" id="reasonOtherText" placeholder="Nh·∫≠p l√Ω do kh√°c" rows="3"></textarea>
            <small class="text-muted">N·∫øu ch·ªçn "Kh√°c", vui l√≤ng nh·∫≠p l√Ω do ·ªü ƒë√¢y.</small>
        </div>
     <button class="btn btn-danger w-100" type="submit" id="cancelSubmitBtn">X√°c nh·∫≠n h·ªßy ƒë∆°n</button>
   </form>
  </div>
   </div>
  }
</div>

<!-- Cancel Modal for Admin -->
@if (isAdmin)
{
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
     <div class="modal-content">
                <div class="modal-header bg-danger text-white">
 <h5 class="modal-title" id="cancelModalLabel">H·ªßy ƒë∆°n h√†ng</h5>
       <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
        <form asp-action="Cancel" asp-controller="Orders" method="post">
   @Html.AntiForgeryToken()
            <div class="modal-body">
                  <input type="hidden" name="id" value="@Model.Id" />
            <div class="mb-3">
                <label class="form-label">L√Ω do h·ªßy (b·∫Øt bu·ªôc)</label>
                <div class="list-group">
                    <label class="list-group-item">
                        <input class="form-check-input me-2" type="radio" name="note" value="x√°c nh·∫≠n m·∫•t h√†ng" required>
                        Ng∆∞·ªùi b√°n x√°c nh·∫≠n m·∫•t h√†ng
                    </label>
                    <label class="list-group-item">
                        <input class="form-check-input me-2" type="radio" name="note" value=" x√°c nh·∫≠n h·ªèng h√†ng" required>
                        Ng∆∞·ªùi b√°n x√°c nh·∫≠n h·ªèng h√†ng
                    </label>
                    <label class="list-group-item">
                        <input class="form-check-input me-2" type="radio" name="note" value="Kh√¥ng li√™n l·∫°c ƒë∆∞·ª£c kh√°ch" required>
                        Kh√¥ng li√™n l·∫°c ƒë∆∞·ª£c kh√°ch
                    </label>
                    <label class="list-group-item">
                        <input class="form-check-input me-2" type="radio" name="note" value="__OTHER_ADMIN__" required id="adminOtherRadio">
                        Kh√°c
                    </label>
                </div>
            </div>
            <div class="mb-3" id="adminOtherBox" style="display:none;">
                <textarea class="form-control" id="adminOtherText" placeholder="Nh·∫≠p l√Ω do kh√°c" rows="3"></textarea>
                <small class="text-muted">N·∫øu ch·ªçn "Kh√°c", vui l√≤ng nh·∫≠p l√Ω do ·ªü ƒë√¢y.</small>
            </div>
             </div>
<div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
              <button type="submit" class="btn btn-danger">X√°c nh·∫≠n h·ªßy</button>
      </div>
        </form>
         </div>
     </div>
    </div>
}

<style>
    .timeline {
  position: relative;
        padding: 20px 0;
    }
    
    .timeline-item {
    display: flex;
        align-items: center;
   margin-bottom: 20px;
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }
    
    .timeline-item.completed,
    .timeline-item.active {
        opacity: 1;
    }
  
    .timeline-marker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 12px;
 flex-shrink: 0;
border: 2px solid #fff;
        display: flex;
   align-items: center;
        justify-content: center;
        font-weight: bold;
      color: white;
    }
    
    .timeline-content {
        flex: 1;
        font-weight: 500;
    }
    
    .sticky-top {
        position: sticky !important;
    }
</style>

<script>
    (function(){
        const otherRadio = document.getElementById('reasonOtherRadio');
        const otherBox = document.getElementById('reasonOtherBox');
        const otherText = document.getElementById('reasonOtherText');
        const form = otherRadio ? otherRadio.closest('form') : null;
        if (!form) return;

        form.addEventListener('change', function(e){
            const selected = form.querySelector('input[name="note"]:checked');
            if (!selected) return;
            const isOther = selected && selected.value === '__OTHER__';
            otherBox.style.display = isOther ? 'block' : 'none';
        });

        form.addEventListener('submit', function(e){
            const selected = form.querySelector('input[name="note"]:checked');
            if (!selected) return; // HTML required should handle
            if (selected.value === '__OTHER__'){
                const val = (otherText.value || '').trim();
                if (!val){
                    e.preventDefault();
                    otherText.focus();
                    return;
                }
                // Replace the radio value with custom text before submit
                selected.value = val;
            }
        });
    })();

    // Admin cancel modal behavior
    (function(){
        const adminOtherRadio = document.getElementById('adminOtherRadio');
        const adminOtherBox = document.getElementById('adminOtherBox');
        const adminOtherText = document.getElementById('adminOtherText');
        const modal = document.getElementById('cancelModal');
        if (!modal) return;
        const form = modal.querySelector('form');
        if (!form) return;

        form.addEventListener('change', function(){
            const selected = form.querySelector('input[name="note"]:checked');
            if (!selected) return;
            const isOther = selected.value === '__OTHER_ADMIN__';
            if (adminOtherBox) adminOtherBox.style.display = isOther ? 'block' : 'none';
        });

        form.addEventListener('submit', function(e){
            const selected = form.querySelector('input[name="note"]:checked');
            if (!selected) return;
            if (selected.value === '__OTHER_ADMIN__'){
                const val = (adminOtherText?.value || '').trim();
                if (!val){ e.preventDefault(); adminOtherText?.focus(); return; }
                selected.value = val;
            }
        });
    })();
</script>
