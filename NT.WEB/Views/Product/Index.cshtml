@model IEnumerable<NT.SHARED.Models.Product>
@using NT.SHARED.Constants

@{
    ViewBag.Title = "Quản lý sản phẩm";
}

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- LEFT SIDEBAR MENU -->
     <aside class="col-xl-2 col-lg-3">
   <div class="card shadow-sm sticky-top" style="top: 20px;">
<div class="card-body">
     <a asp-controller="Home" asp-action="Index" class="d-block mb-3">
    <img src="~/css/logo (1).png" alt="Logo" style="height: 36px;">
   </a>

        <div class="mb-3 pb-3 border-bottom">
  <div class="fw-bold small">Quản lý sản phẩm</div>
              </div>

             <nav class="nav flex-column gap-1">
      @*  <a asp-controller="Admin" asp-action="Index" class="nav-link nav-link-primary fw-500">
    <i class="bi bi-collection me-2"></i>Danh Mục
 </a> *@
      <a asp-controller="Color" asp-action="Index" class="nav-link nav-link-primary fw-500">
       <i class="bi bi-palette2 me-2"></i>Màu Sắc
 </a>
   <a asp-controller="Length" asp-action="Index" class="nav-link nav-link-primary fw-500">
        <i class="bi bi-rulers me-2"></i>Chiều Dài
        </a>
<a asp-controller="SurfaceFinish" asp-action="Index" class="nav-link nav-link-primary fw-500">
<i class="bi bi-layers me-2"></i>Bề Mặt
     </a>
     <a asp-controller="Hardness" asp-action="Index" class="nav-link nav-link-primary fw-500">
   <i class="bi bi-hammer me-2"></i>Độ Cứng
  </a>
   <a asp-controller="Elasticity" asp-action="Index" class="nav-link nav-link-primary fw-500">
  <i class="bi bi-arrow-repeat me-2"></i>Độ Đàn Hồi
</a>
         <a asp-controller="OriginCountry" asp-action="Index" class="nav-link nav-link-primary fw-500">
    <i class="bi bi-globe me-2"></i>Xuất Xứ
         </a>
 @*  Ẩn phần Ảnh Sản Phẩm theo yêu cầu
 <a asp-controller="ProductImage" asp-action="Index" class="nav-link nav-link-primary fw-500">
             <i class="bi bi-image me-2"></i>Ảnh Sản Phẩm
      </a>
 *@
           </nav>
       </div>
    </div>
        </aside>

        <!-- MAIN CONTENT -->
    <main class="col-xl-10 col-lg-9">
          <!-- HEADER -->
           <div class="mb-4">
     <div class="d-flex align-items-center justify-content-between mb-3">
     <div>
     <h1 class="h3 mb-0">Quản lý Sản phẩm</h1>
      <p class="text-muted small mb-0">Tổng: <strong>@(Model?.Count() ?? 0)</strong> sản phẩm</p>
     </div>
     <a asp-action="Create" class="btn btn-primary btn-lg fw-bold">
  <i class="bi bi-plus-circle"></i> Tạo sản phẩm mới
                 </a>
     </div>
             </div>

 <!-- SEARCH & FILTER -->
     <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
  <form method="get" asp-action="Index" class="position-relative">
                <div class="input-group input-group-lg">
   <input type="text" 
    id="product-search" 
  name="q" 
    value="@(Context.Request.Query["q"])" 
       class="form-control" 
    placeholder="Tìm kiếm theo tên, mã sản phẩm..." 
    autocomplete="off" />
   <button type="submit" class="btn btn-outline-secondary fw-bold">
  <i class="bi bi-search"></i> Tìm kiếm
       </button>
        </div>

         <!-- Suggestions Dropdown -->
                <div id="suggestions" class="list-group position-absolute" 
      style="z-index: 1000; width: 100%; left: 0; top: 52px; display: none; max-height: 400px; overflow-y: auto;">
      </div>
               </form>
            </div>
        </div>

     <!-- PRODUCTS TABLE -->
        <div class="card shadow-sm border-0">
                <div class="card-body p-0">
        <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
             <thead class="table-light">
    <tr>
     <th style="width: 10%;">Mã SP</th>
       <th style="width: 8%;">Ảnh</th>
        <th style="width: 28%;">Tên Sản phẩm</th>
        <th style="width: 15%;">Thương hiệu</th>
        <th style="width: 12%;">Trạng thái</th>
               <th style="width: 27%;">Hành động</th>
         </tr>
      </thead>
                <tbody>
      @if (!(Model?.Any() ?? false))
    {
   <tr>
        <td colspan="6" class="text-center py-5 text-muted">
        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
   <p class="mt-3">Chưa có sản phẩm</p>
       </td>
      </tr>
    }
    else
              {
     @foreach(var p in Model)
     {
  <tr class="border-bottom">
         <td>
 <code class="text-primary fw-semibold">@p.ProductCode</code>
  </td>
     <td>
  @if(!string.IsNullOrWhiteSpace(p.Thumbnail))
  {
       <img src="@p.Thumbnail" alt="thumb" 
         style="width: 56px; height: 56px; object-fit: cover; border-radius: 6px;" 
           class="shadow-sm" />
  }
   else
   {
        <img src="/images/product-placeholder.png" alt="thumb" 
      style="width: 56px; height: 56px; object-fit: cover; border-radius: 6px; opacity: 0.3;" />
    }
            </td>
      <td>
    <div class="fw-semibold">@p.Name</div>
       <small class="text-muted">@(p.ShortDescription?.Substring(0, Math.Min(50, p.ShortDescription?.Length ?? 0)) ?? "-")</small>
      </td>
 <td>
     <span class="badge bg-light text-dark">@(p.Brand?.Name ?? "N/A")</span>
              </td>
   <td>
     @if(p.Status == ProductStatus.Active)
     {
         <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>@ProductStatus.GetDisplayName(ProductStatus.Active)</span>
     }
     else
     {
         <span class="badge bg-danger"><i class="bi bi-x-circle me-1"></i>@ProductStatus.GetDisplayName(ProductStatus.Inactive)</span>
     }
   </td>
   <td>
   <div class="btn-group btn-group-sm" role="group">
        <a asp-action="Details" asp-route-id="@p.Id" class="btn btn-outline-info" title="Xem chi tiết">
    <i class="bi bi-eye"></i> Chi tiết
             </a>
      <a asp-action="Edit" asp-route-id="@p.Id" class="btn btn-outline-primary" title="Chỉnh sửa">
         <i class="bi bi-pencil"></i> Sửa
      </a>
 <button class="btn btn-outline-danger" type="button" 
        data-bs-toggle="modal" data-bs-target="#deleteModal-@p.Id" title="Xóa">
    <i class="bi bi-trash"></i> Xóa
      </button>
            </div>
   </td>
     </tr>

     <!-- Delete Modal -->
<div class="modal fade" id="deleteModal-@p.Id" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
   <div class="modal-content">
        <div class="modal-header bg-danger text-white">
      <h5 class="modal-title">Xác nhận xóa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
  </div>
      <div class="modal-body">
   <p>Bạn có chắc muốn xóa sản phẩm <strong>@p.Name</strong>?</p>
         </div>
  <div class="modal-footer">
           <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
       <a asp-action="Delete" asp-route-id="@p.Id" class="btn btn-danger">Xóa</a>
</div>
   </div>
   </div>
        </div>
 }
    }
        </tbody>
      </table>
     </div>
       </div>
      </div>
         </main>
    </div>
</div>

<style>
    .nav-link-primary {
        color: #495057;
        transition: all 0.2s ease;
    }

    .nav-link-primary:hover,
    .nav-link-primary.active {
        color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.1);
        border-radius: 6px;
    }
</style>

@section Scripts {
    <script>
     (function(){
            const input = document.getElementById('product-search');
         const box = document.getElementById('suggestions');
     let timer = null;

            function hide() { 
    box.style.display = 'none'; 
             box.innerHTML = ''; 
   }

   function currency(n){
try { 
       return new Intl.NumberFormat('vi-VN', { 
          style: 'currency', 
     currency: 'VND', 
      maximumFractionDigits: 0 
              }).format(n); 
     } catch { 
           return n; 
                }
    }

            function show(items){
       if(!items || items.length === 0){ 
  hide(); 
    return; 
      }
   box.innerHTML = items.map(i => `
            <a href="/Product/Details/${i.id}" class="list-group-item list-group-item-action d-flex align-items-center gap-2 border-0 py-2">
            <img src="${i.thumbnail || '/images/product-placeholder.png'}" 
          class="flex-shrink-0" 
    style="width: 44px; height: 44px; object-fit: cover; border-radius: 6px;" 
             alt="thumb"/>
              <div class="flex-grow-1 min-width-0">
       <div class="fw-semibold small">
   ${i.name} 
    <code class="text-muted">${i.productCode || ''}</code>
 </div>
   <div class="small text-muted">
     ${i.priceMin ? currency(i.priceMin) : ''}${i.priceMax ? (' - ' + currency(i.priceMax)) : ''}
  </div>
         </div>
        </a>
    `).join('');
         box.style.display = 'block';
            }

        input.addEventListener('input', function(){
       const q = this.value.trim();
  if(timer) clearTimeout(timer);
        if(q.length < 1){ 
      hide(); 
    return; 
      }
     timer = setTimeout(async () => {
      try {
   const res = await fetch(`/Product/Suggest?q=${encodeURIComponent(q)}`);
       if(!res.ok) { 
  hide(); 
  return; 
               }
   const data = await res.json();
           show(data);
         } catch(e) { 
         hide(); 
       }
 }, 250);
      });

      // close when clicking outside
        document.addEventListener('click', function(e){ 
  if(!box.contains(e.target) && e.target !== input) { 
          hide(); 
} 
            });
        })();
    </script>
}
