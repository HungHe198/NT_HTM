@{
    Layout = "~/Views/Shared/_ClientLayout.cshtml";
    var product = ViewBag.Product as NT.SHARED.Models.Product;
    var details = ViewBag.Details as IEnumerable<NT.SHARED.Models.ProductDetail> ?? Enumerable.Empty<NT.SHARED.Models.ProductDetail>();
    var detailImages = ViewBag.DetailImages as Dictionary<Guid, List<string>> ?? new Dictionary<Guid, List<string>>();
    var hardnessOptions = ViewBag.HardnessOptions as IEnumerable<NT.SHARED.Models.Hardness> ?? Enumerable.Empty<NT.SHARED.Models.Hardness>();
    var lengthOptions = ViewBag.LengthOptions as IEnumerable<NT.SHARED.Models.Length> ?? Enumerable.Empty<NT.SHARED.Models.Length>();
    var isOutOfStock = ViewBag.IsOutOfStock as bool? ?? false;
    
    var allVariantImages = new List<(Guid detailId, string imageUrl)>();
    foreach (var d in details)
    {
        if (detailImages.TryGetValue(d.Id, out var imgs))
        {
            foreach (var img in imgs)
            {
                allVariantImages.Add((d.Id, img));
            }
        }
    }
}

@section Styles {
<style>
    .product-detail-page {
        background: linear-gradient(135deg, #f5f7fb 0%, #e8f4f8 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .product-detail-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        border: none;
    }
    
    .product-image-section {
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        padding: 1.5rem;
        border-radius: 16px;
    }
    
    .main-image-wrapper {
        position: relative;
        border-radius: 16px;
        overflow: hidden;
        background: linear-gradient(135deg, #f5f5f5, #fafafa);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .main-image-wrapper img {
        transition: transform 0.4s ease;
    }
    
    .main-image-wrapper:hover img {
        transform: scale(1.02);
    }
    
    .thumbnail-gallery {
        display: flex;
        gap: 10px;
        padding: 10px 0;
        overflow-x: auto;
        scrollbar-width: thin;
    }
    
    .thumbnail-img {
        width: 75px;
        height: 75px;
        object-fit: cover;
        border-radius: 12px;
        border: 3px solid #e9ecef;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .thumbnail-img:hover, .thumbnail-img.active {
        border-color: #00838f;
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 131, 143, 0.3);
    }
    
    .product-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: #263238;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .product-code {
        display: inline-block;
        background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
        color: #00838f;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .brand-badge {
        background: linear-gradient(135deg, #00838f, #00bcd4);
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 4px 15px rgba(0, 131, 143, 0.3);
    }
    
    .price-display {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        padding: 1rem 1.5rem;
        border-radius: 16px;
        margin: 1rem 0;
    }
    
    .price-main {
        font-size: 1.8rem;
        font-weight: 700;
        background: linear-gradient(135deg, #ff5722, #ff9800);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .price-range {
        font-size: 1.2rem;
        color: #ff9800;
        font-weight: 500;
    }
    
    .variant-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e0f7fa;
    }
    
    .variant-card-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #00838f;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .option-label {
        font-weight: 600;
        color: #37474f;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
    }
    
    .option-btn {
        border-radius: 25px !important;
        padding: 8px 18px !important;
        font-weight: 500 !important;
        border: 2px solid #e0e0e0 !important;
        background: white !important;
        color: #37474f !important;
        transition: all 0.3s ease !important;
    }
    
    .option-btn:hover:not(:disabled) {
        border-color: #00838f !important;
        background: #e0f7fa !important;
        color: #00838f !important;
        transform: translateY(-2px);
    }
    
    .option-btn.btn-primary {
        background: linear-gradient(135deg, #00838f, #00bcd4) !important;
        border-color: #00838f !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(0, 131, 143, 0.3);
    }
    
    .option-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .qty-control {
        display: flex;
        align-items: center;
        gap: 0;
        background: #f5f5f5;
        border-radius: 30px;
        padding: 4px;
        width: fit-content;
    }
    
    .qty-control button {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: white;
        color: #00838f;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .qty-control button:hover {
        background: #00838f;
        color: white;
    }
    
    .qty-control input {
        width: 60px;
        text-align: center;
        border: none;
        background: transparent;
        font-weight: 600;
        font-size: 1.1rem;
        color: #263238;
    }
    
    .qty-control input:focus {
        outline: none;
    }
    
    .selection-summary {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border: none;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        color: #1565c0;
        font-weight: 500;
    }
    
    .selection-summary.alert-danger {
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        color: #c62828;
    }
    
    .action-btn {
        padding: 14px 28px;
        border-radius: 30px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-add-cart {
        background: linear-gradient(135deg, #ff9800, #ffc107);
        border: none;
        color: white;
        box-shadow: 0 4px 20px rgba(255, 152, 0, 0.4);
    }
    
    .btn-add-cart:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 152, 0, 0.5);
        background: linear-gradient(135deg, #f57c00, #ffb300);
        color: white;
    }
    
    .btn-buy-now {
        background: linear-gradient(135deg, #e53935, #ff5252);
        border: none;
        color: white;
        box-shadow: 0 4px 20px rgba(229, 57, 53, 0.4);
    }
    
    .btn-buy-now:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(229, 57, 53, 0.5);
        background: linear-gradient(135deg, #c62828, #e53935);
        color: white;
    }
    
    .description-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        border: none;
    }
    
    .description-header {
        background: linear-gradient(135deg, #00838f, #00bcd4);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .description-body {
        padding: 1.5rem;
        color: #546e7a;
        line-height: 1.8;
    }
    
    .specs-table-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .specs-header {
        background: linear-gradient(135deg, #00838f, #00bcd4);
        color: white;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .specs-header h4 {
        margin: 0;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .variant-count-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
    }
    
    .specs-table {
        margin: 0;
    }
    
    .specs-table thead {
        background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
    }
    
    .specs-table thead th {
        border: none;
        padding: 1rem;
        font-weight: 600;
        color: #00695c;
        font-size: 0.9rem;
    }
    
    .specs-table tbody tr {
        transition: all 0.3s ease;
    }
    
    .specs-table tbody tr:hover {
        background: #f5f5f5;
    }
    
    .specs-table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: #f0f0f0;
    }
    
    .stock-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .stock-badge.in-stock {
        background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        color: #2e7d32;
    }
    
    .stock-badge.out-of-stock {
        background: linear-gradient(135deg, #ffcdd2, #ef9a9a);
        color: #c62828;
    }
    
    .detail-btn {
        background: linear-gradient(135deg, #00838f, #00bcd4);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .detail-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 131, 143, 0.4);
        color: white;
    }
    
    .gallery-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .gallery-header {
        background: linear-gradient(135deg, #00838f, #00bcd4);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .gallery-item {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .gallery-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .gallery-item img {
        transition: transform 0.4s ease;
    }
    
    .gallery-item:hover img {
        transform: scale(1.08);
    }
    
    .gallery-item-label {
        background: linear-gradient(135deg, rgba(0, 131, 143, 0.9), rgba(0, 188, 212, 0.9));
        color: white;
        padding: 0.5rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .modal-modern .modal-content {
        border-radius: 20px;
        overflow: hidden;
        border: none;
    }
    
    .modal-modern .modal-header {
        background: linear-gradient(135deg, #00838f, #00bcd4);
        color: white;
        border: none;
        padding: 1rem 1.5rem;
    }
    
    .modal-modern .modal-title {
        font-weight: 600;
    }
    
    .modal-modern .btn-close {
        filter: brightness(0) invert(1);
    }
    
    .modal-modern .modal-body {
        padding: 1.5rem;
    }
    
    .modal-modern .modal-footer {
        border-top: 1px solid #e0e0e0;
        padding: 1rem 1.5rem;
    }
    
    .info-section-title {
        color: #00838f;
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e0f7fa;
    }
    
    .info-table td {
        padding: 0.5rem 0;
        border: none;
    }
    
    .info-table td:first-child {
        color: #78909c;
        width: 40%;
    }
    
    .info-table td:last-child {
        font-weight: 600;
        color: #37474f;
    }
    
    .variant-images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
    }
    
    .variant-image-item {
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .variant-image-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .lightbox-modal .modal-content {
        background: rgba(0, 0, 0, 0.95);
        border: none;
    }
</style>
}

<div class="product-detail-page">
    <div class="container">
        <!-- PRODUCT MAIN SECTION -->
        <div class="row g-4 mb-5">
            <!-- LEFT: IMAGES & GALLERY -->
            <div class="col-lg-5">
                <div class="product-detail-card position-sticky" style="top: 100px;">
                    <div class="product-image-section">
                        <!-- Main Product Image -->
                        <div class="main-image-wrapper ratio ratio-1x1 mb-3">
                            <img id="main-product-image" 
                                 src="@((product?.Thumbnail) ?? "/images/product-placeholder.png")" 
                                 alt="@product?.Name" 
                                 class="img-fluid" 
                                 style="object-fit: contain; cursor: zoom-in;"
                                 onclick="openLightbox(this.src)" />
                        </div>

                        <!-- Thumbnail Gallery -->
                        <div class="thumbnail-gallery">
                            @if (!string.IsNullOrWhiteSpace(product?.Thumbnail))
                            {
                                <img src="@product.Thumbnail" 
                                     alt="Ảnh chính" 
                                     class="thumbnail-img active" 
                                     data-detail-id="" 
                                     data-image-url="@product.Thumbnail"
                                     onclick="selectThumbnail(this)" />
                            }
                            @foreach (var item in allVariantImages.Take(8))
                            {
                                <img src="@item.imageUrl" 
                                     alt="Ảnh biến thể" 
                                     class="thumbnail-img" 
                                     data-detail-id="@item.detailId" 
                                     data-image-url="@item.imageUrl"
                                     onclick="selectThumbnail(this)" />
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: PRODUCT INFO & SELECTION -->
            <div class="col-lg-7">
                <!-- Header Info -->
                <div class="mb-4">
                    <div class="d-flex align-items-start justify-content-between mb-3 flex-wrap gap-2">
                        <div>
                            <h1 class="product-title">@product?.Name</h1>
                            <span class="product-code">
                                <i class="fas fa-barcode me-1"></i> @product?.ProductCode
                            </span>
                        </div>
                        @if (product?.Brand != null)
                        {
                            <span class="brand-badge">
                                <i class="fas fa-tag me-1"></i> @product.Brand.Name
                            </span>
                        }
                    </div>

                    @if (!string.IsNullOrWhiteSpace(product?.ShortDescription))
                    {
                        <p class="text-muted lead mb-3">@product.ShortDescription</p>
                    }

                    <!-- Thông báo hết hàng -->
                    @if (isOutOfStock)
                    {
                        <div class="alert alert-danger d-flex align-items-center mb-3" role="alert" style="border-radius: 12px;">
                            <i class="fas fa-exclamation-circle fa-2x me-3"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Sản phẩm tạm hết hàng</h5>
                                <p class="mb-0">Rất tiếc, sản phẩm này hiện đang hết hàng. Vui lòng quay lại sau hoặc liên hệ shop để đặt trước.</p>
                            </div>
                        </div>
                    }

                    <!-- Price Range -->
                    @if (details.Any())
                    {
                        var minPrice = details.Min(d => d.Price);
                        var maxPrice = details.Max(d => d.Price);
                        <div class="price-display">
                            <span class="price-main">@minPrice.ToString("#,##0")₫</span>
                            @if (minPrice != maxPrice)
                            {
                                <span class="price-range"> – @maxPrice.ToString("#,##0")₫</span>
                            }
                        </div>
                    }
                </div>

                <!-- Variant Selection Card -->
                @if (!isOutOfStock)
                {
                <div class="variant-card">
                    <h5 class="variant-card-title">
                        <i class="fas fa-sliders-h"></i> Chọn thông số
                    </h5>

                    <!-- Hardness Options -->
                    <div class="mb-4">
                        <label class="option-label"><i class="fas fa-gem me-2"></i>Độ cứng</label>
                        <div id="hardness-options" class="d-flex flex-wrap gap-2">
                            @foreach (var h in hardnessOptions)
                            {
                                var countForH = details.Count(d => d.HardnessId == h.Id && d.StockQuantity > 0);
                                var isDisabled = countForH == 0;
                                <button type="button"
                                        class="btn option-btn hardness-btn"
                                        data-hardness-id="@h.Id"
                                        @(isDisabled ? "disabled" : "")>
                                    @h.Name
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Length Options -->
                    <div class="mb-4">
                        <label class="option-label"><i class="fas fa-ruler me-2"></i>Chiều dài</label>
                        <div id="length-options" class="d-flex flex-wrap gap-2">
                            @foreach (var l in lengthOptions)
                            {
                                var countForL = details.Count(d => d.LengthId == l.Id && d.StockQuantity > 0);
                                var isDisabled = countForL == 0;
                                <button type="button"
                                        class="btn option-btn length-btn"
                                        data-length-id="@l.Id"
                                        @(isDisabled ? "disabled" : "")>
                                    @l.Name
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="mb-4">
                        <label class="option-label"><i class="fas fa-sort-numeric-up me-2"></i>Số lượng</label>
                        <div class="qty-control">
                            <button type="button" id="qty-minus">−</button>
                            <input type="number" id="qty" value="1" min="1" />
                            <button type="button" id="qty-plus">+</button>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="selection-summary" id="selection-summary">
                        <i class="fas fa-info-circle me-2"></i> Vui lòng chọn độ cứng và chiều dài
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-grid gap-3 d-sm-flex mb-4">
                    <button id="add-to-cart" class="btn action-btn btn-add-cart flex-fill">
                        <i class="fas fa-cart-plus"></i> Thêm vào giỏ
                    </button>
                    <button id="buy-now" class="btn action-btn btn-buy-now flex-fill">
                        <i class="fas fa-bolt"></i> Mua ngay
                    </button>
                </div>
                }
                else
                {
                    <!-- Thông báo và nút liên hệ khi hết hàng -->
                    <div class="variant-card">
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">Sản phẩm tạm hết hàng</h5>
                            <p class="text-muted mb-4">Vui lòng liên hệ với chúng tôi để đặt trước hoặc quay lại sau.</p>
                            <div class="d-grid gap-2 d-sm-flex justify-content-center">
                                <a href="/" class="btn btn-outline-primary action-btn">
                                    <i class="fas fa-home"></i> Về trang chủ
                                </a>
                                <a href="tel:0901234567" class="btn btn-success action-btn">
                                    <i class="fas fa-phone"></i> Liên hệ đặt hàng
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- DESCRIPTION SECTION -->
        @if (!string.IsNullOrWhiteSpace(product?.Description))
        {
            <div class="description-card mb-5">
                <div class="description-header">
                    <i class="fas fa-file-alt me-2"></i> Mô tả sản phẩm
                </div>
                <div class="description-body">
                    @Html.Raw(product.Description)
                </div>
            </div>
        }

        <!-- VARIANTS SPECIFICATIONS TABLE -->
        <div class="specs-table-card mb-5">
            <div class="specs-header">
                <h4><i class="fas fa-list-alt me-2"></i> Thông số các biến thể</h4>
                <span class="variant-count-badge">@details.Count() biến thể</span>
            </div>
  
            @if (details.Any())
            {
                <div class="table-responsive">
                    <table class="table specs-table align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width: 5%;">STT</th>
                                <th style="width: 15%;">Chiều dài</th>
                                <th style="width: 15%;">Độ cứng</th>
                                <th style="width: 12%;">Màu sắc</th>
                                <th style="width: 13%;">Giá</th>
                                <th style="width: 15%;">Tồn kho</th>
                                <th style="width: 10%; text-align: center;">Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{ var index = 1; }
                            @foreach (var detail in details)
                            {
                                <tr class="variant-row" data-detail-id="@detail.Id">
                                    <td class="fw-bold text-center">@index</td>
                                    <td>@(detail.Length?.Name ?? "N/A")</td>
                                    <td>@(detail.Hardness?.Name ?? "N/A")</td>
                                    <td>@(detail.Color?.Name ?? "N/A")</td>
                                    <td class="fw-bold" style="color: #ff5722;">@detail.Price.ToString("#,##0")₫</td>
                                    <td>
                                        @if (detail.StockQuantity > 0)
                                        {
                                            <span class="stock-badge in-stock">Còn @detail.StockQuantity</span>
                                        }
                                        else
                                        {
                                            <span class="stock-badge out-of-stock">Hết hàng</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn detail-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#detailModal-@detail.Id">
                                            <i class="fas fa-info"></i>
                                        </button>
                                    </td>
                                </tr>
                                index++;
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Detail Modals -->
                @foreach (var detail in details)
                {
                    <div class="modal fade modal-modern" id="detailModal-@detail.Id" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="fas fa-cube me-2"></i>
                                        <strong>@(detail.Length?.Name)</strong> · @(detail.Hardness?.Name) · @(detail.Color?.Name)
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-4 mb-4">
                                        <div class="col-md-6">
                                            <h6 class="info-section-title"><i class="fas fa-info-circle me-2"></i>Thông tin cơ bản</h6>
                                            <table class="table info-table">
                                                <tr><td>Chiều dài</td><td>@(detail.Length?.Name ?? "-")</td></tr>
                                                <tr><td>Độ cứng</td><td>@(detail.Hardness?.Name ?? "-")</td></tr>
                                                <tr><td>Màu sắc</td><td>@(detail.Color?.Name ?? "-")</td></tr>
                                                <tr><td>Độ đàn hồi</td><td>@(detail.Elasticity?.Name ?? "-")</td></tr>
                                                <tr><td>Bề mặt</td><td>@(detail.SurfaceFinish?.Name ?? "-")</td></tr>
                                                <tr><td>Xuất xứ</td><td>@(detail.OriginCountry?.Name ?? "-")</td></tr>
                                                <tr><td>Giá</td><td style="color: #ff5722; font-weight: 700;">@detail.Price.ToString("#,##0")₫</td></tr>
                                                <tr><td>Tồn kho</td><td>@detail.StockQuantity</td></tr>
                                                <tr><td>Đã bán</td><td>@detail.SoldQuantity</td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="info-section-title"><i class="fas fa-cogs me-2"></i>Thông số kỹ thuật</h6>
                                            <table class="table info-table">
                                                <tr><td>Số lóng</td><td>@(detail.Sections ?? "-")</td></tr>
                                                <tr><td>Chiều dài gập</td><td>@(detail.CollapsedLength ?? "-")</td></tr>
                                                <tr><td>Trọng lượng</td><td>@(detail.Weight ?? "-")</td></tr>
                                                <tr><td>TL đầu</td><td>@(detail.TipWeight ?? "-")</td></tr>
                                                <tr><td>TL cán</td><td>@(detail.ButtWeight ?? "-")</td></tr>
                                                <tr><td>ĐK ngọn</td><td>@(detail.TipDiameter ?? "-")</td></tr>
                                                <tr><td>ĐK đầu</td><td>@(detail.TopDiameter ?? "-")</td></tr>
                                                <tr><td>ĐK cán</td><td>@(detail.ButtDiameter ?? "-")</td></tr>
                                                <tr><td>Điểm cân bằng</td><td>@(detail.BalancePoint ?? "-")</td></tr>
                                            </table>
                                        </div>
                                    </div>
   
                                    @if (!string.IsNullOrWhiteSpace(detail.RecommendedLine) || 
                                         !string.IsNullOrWhiteSpace(detail.RecommendedFishWeight) || 
                                         !string.IsNullOrWhiteSpace(detail.HandleType) || 
                                         !string.IsNullOrWhiteSpace(detail.JointType) || 
                                         !string.IsNullOrWhiteSpace(detail.Warranty))
                                    {
                                        <div class="border-top pt-3">
                                            <h6 class="info-section-title"><i class="fas fa-plus-circle me-2"></i>Thông tin bổ sung</h6>
                                            <table class="table info-table">
                                                @if (!string.IsNullOrWhiteSpace(detail.RecommendedLine))
                                                {
                                                    <tr><td>Dây câu đề xuất</td><td>@detail.RecommendedLine</td></tr>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(detail.RecommendedFishWeight))
                                                {
                                                    <tr><td>Cá đề xuất</td><td>@detail.RecommendedFishWeight</td></tr>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(detail.HandleType))
                                                {
                                                    <tr><td>Loại tay cầm</td><td>@detail.HandleType</td></tr>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(detail.JointType))
                                                {
                                                    <tr><td>Loại khớp nối</td><td>@detail.JointType</td></tr>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(detail.Warranty))
                                                {
                                                    <tr><td>Bảo hành</td><td>@detail.Warranty</td></tr>
                                                }
                                            </table>
                                        </div>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(detail.BalanceLoadDescription))
                                    {
                                        <div class="border-top pt-3">
                                            <h6 class="info-section-title"><i class="fas fa-balance-scale me-2"></i>Mô tả tải</h6>
                                            <p class="text-muted mb-0">@detail.BalanceLoadDescription</p>
                                        </div>
                                    }

                                    <!-- Variant Images -->
                                    @if (detailImages.TryGetValue(detail.Id, out var variantImgs) && variantImgs.Any())
                                    {
                                        <div class="border-top pt-3 mt-3">
                                            <h6 class="info-section-title"><i class="fas fa-images me-2"></i>Hình ảnh biến thể</h6>
                                            <div class="variant-images-grid">
                                                @foreach (var imgUrl in variantImgs)
                                                {
                                                    <img src="@imgUrl" alt="Ảnh biến thể" 
                                                         class="variant-image-item img-fluid" 
                                                         style="width: 100%; height: 100px; object-fit: cover;"
                                                         onclick="openLightbox('@imgUrl')" />
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i> Đóng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Chưa có biến thể nào cho sản phẩm này.</p>
                </div>
            }
        </div>

        <!-- GALLERY SECTION -->
        @if (!string.IsNullOrWhiteSpace(product?.Thumbnail) || allVariantImages.Any())
        {
            <div class="gallery-card mb-5">
                <div class="gallery-header">
                    <i class="fas fa-images me-2"></i> Bộ sưu tập ảnh
                </div>
                <div class="p-4">
                    <div class="row g-3">
                        @if (!string.IsNullOrWhiteSpace(product?.Thumbnail))
                        {
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="gallery-item" onclick="openLightbox('@product.Thumbnail')">
                                    <div class="ratio ratio-1x1">
                                        <img src="@product.Thumbnail" alt="Ảnh đại diện" class="img-fluid" style="object-fit: cover;">
                                    </div>
                                    <div class="gallery-item-label text-center">
                                        <i class="fas fa-star me-1"></i> Ảnh đại diện
                                    </div>
                                </div>
                            </div>
                        }

                        @foreach (var detail in details)
                        {
                            if (detailImages.TryGetValue(detail.Id, out var variantImgs) && variantImgs.Any())
                            {
                                var firstImg = variantImgs.FirstOrDefault();
                                <div class="col-6 col-md-4 col-lg-3">
                                    <div class="gallery-item" onclick="openLightbox('@firstImg')">
                                        <div class="ratio ratio-1x1">
                                            <img src="@firstImg" alt="Ảnh" class="img-fluid" style="object-fit: cover;">
                                        </div>
                                        <div class="gallery-item-label text-center text-truncate">
                                            @detail.Length?.Name · @detail.Hardness?.Name
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Lightbox Modal -->
<div class="modal fade lightbox-modal" id="lightboxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0 position-absolute w-100" style="z-index: 10;">
                <button type="button" class="btn-close btn-close-white ms-auto me-3 mt-3" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex align-items-center justify-content-center p-0">
                <img id="lightboxImage" src="" alt="Ảnh phóng to" class="img-fluid" style="max-height: 90vh; object-fit: contain;">
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
    <div id="pd-toast" class="toast align-items-center text-white border-0" role="alert">
        <div class="d-flex">
            <div id="pd-toast-body" class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const details = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((details).Select(d => new {
        id = d.Id,
        price = d.Price,
        stock = d.StockQuantity,
        lengthId = d.LengthId,
        hardnessId = d.HardnessId
    })));

    const detailImagesMap = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(detailImages.ToDictionary(kv => kv.Key.ToString(), kv => kv.Value)));
    const productThumbnail = '@Html.Raw((product?.Thumbnail ?? "/images/product-placeholder.png").Replace("'", "\\'"))';
    const isOutOfStock = @(isOutOfStock ? "true" : "false");

    function openLightbox(imageSrc) {
        document.getElementById('lightboxImage').src = imageSrc;
        var lightboxModal = new bootstrap.Modal(document.getElementById('lightboxModal'));
        lightboxModal.show();
    }

    function selectThumbnail(imgEl) {
        document.querySelectorAll('.thumbnail-img').forEach(t => {
            t.classList.remove('active');
        });
        imgEl.classList.add('active');
        document.getElementById('main-product-image').src = imgEl.getAttribute('data-image-url');
    }

    function updateMainImageForVariant(detailId) {
        if (!detailId) {
            document.getElementById('main-product-image').src = productThumbnail;
            document.querySelectorAll('.thumbnail-img').forEach(t => {
                t.classList.remove('active');
            });
            const firstThumb = document.querySelector('.thumbnail-img[data-detail-id=""]');
            if (firstThumb) {
                firstThumb.classList.add('active');
            }
            return;
        }
        const images = detailImagesMap[detailId];
        if (images && images.length > 0) {
            document.getElementById('main-product-image').src = images[0];
            document.querySelectorAll('.thumbnail-img').forEach(t => {
                t.classList.remove('active');
            });
            const matchingThumb = document.querySelector('.thumbnail-img[data-detail-id="' + detailId + '"]');
            if (matchingThumb) {
                matchingThumb.classList.add('active');
            }
        }
    }

    // Chỉ khởi tạo các chức năng chọn biến thể nếu không hết hàng
    if (!isOutOfStock) {
        let selectedHardnessId = null;
        let selectedLengthId = null;

        const hardnessButtons = document.querySelectorAll('.hardness-btn');
        const lengthButtons = document.querySelectorAll('.length-btn');
        const summaryEl = document.getElementById('selection-summary');

        function setActive(btns, idAttr, id) {
            btns.forEach(b => {
                const isActive = id && b.getAttribute(idAttr) === id;
                b.classList.toggle('btn-primary', isActive);
            });
        }

        function updateAvailability() {
            let validDetails = details.filter(d => d.stock > 0);
            if (selectedHardnessId) {
                validDetails = validDetails.filter(d => d.hardnessId === selectedHardnessId);
            }
            if (selectedLengthId) {
                validDetails = validDetails.filter(d => d.lengthId === selectedLengthId);
            }

            const validHardnessIds = new Set(validDetails.map(d => d.hardnessId));
            const validLengthIds = new Set(validDetails.map(d => d.lengthId));

            hardnessButtons.forEach(b => {
                const id = b.getAttribute('data-hardness-id');
                const hasStock = details.some(d => d.hardnessId === id && d.stock > 0);
                b.disabled = !hasStock || (selectedLengthId && !validHardnessIds.has(id));
            });

            lengthButtons.forEach(b => {
                const id = b.getAttribute('data-length-id');
                const hasStock = details.some(d => d.lengthId === id && d.stock > 0);
                b.disabled = !hasStock || (selectedHardnessId && !validLengthIds.has(id));
            });

            if (validDetails.length > 0) {
                const prices = validDetails.map(d => Number(d.price));
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                const totalStock = validDetails.reduce((s,d)=> s + Number(d.stock), 0);
                summaryEl.innerHTML = `<i class="fas fa-check-circle me-2"></i><strong>Giá:</strong> ${min.toLocaleString()}₫${min !== max ? ' – ' + max.toLocaleString() + '₫' : ''} | <strong>Còn:</strong> ${totalStock} sản phẩm`;
                summaryEl.classList.remove('alert-danger');
                summaryEl.classList.add('selection-summary');
          
                if (validDetails.length === 1) {
                    updateMainImageForVariant(validDetails[0].id);
                } else {
                    updateMainImageForVariant(null);
                }
            } else {
                summaryEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Không có sản phẩm phù hợp với lựa chọn của bạn</strong>';
                summaryEl.classList.remove('selection-summary');
                summaryEl.classList.add('alert-danger');
                updateMainImageForVariant(null);
            }
        }

        hardnessButtons.forEach(b => {
            b.addEventListener('click', () => {
                const id = b.getAttribute('data-hardness-id');
                selectedHardnessId = (selectedHardnessId === id) ? null : id;
                setActive(hardnessButtons, 'data-hardness-id', selectedHardnessId);
                updateAvailability();
            });
        });
        
        lengthButtons.forEach(b => {
            b.addEventListener('click', () => {
                const id = b.getAttribute('data-length-id');
                selectedLengthId = (selectedLengthId === id) ? null : id;
                setActive(lengthButtons, 'data-length-id', selectedLengthId);
                updateAvailability();
            });
        });

        document.getElementById('qty-minus').addEventListener('click', () => {
            const qty = document.getElementById('qty');
            qty.value = Math.max(1, parseInt(qty.value || '1') - 1);
        });

        document.getElementById('qty-plus').addEventListener('click', () => {
            const qty = document.getElementById('qty');
            const current = Math.max(1, parseInt(qty.value || '1'));
            // If a variant is selected, cap by its stock
            const selected = findSelectedDetail();
            if (selected && current + 1 > Number(selected.stock)) {
                alert(`Số lượng vượt quá tồn kho (${selected.stock}). Vui lòng giảm số lượng hoặc liên hệ shop.`);
                qty.value = Number(selected.stock);
                return;
            }
            qty.value = current + 1;
        });

        updateAvailability();

        function findSelectedDetail() {
            if (!selectedHardnessId || !selectedLengthId) return null;
            return details.find(d => d.hardnessId === selectedHardnessId && d.lengthId === selectedLengthId && d.stock > 0) || null;
        }

        document.getElementById('add-to-cart').addEventListener('click', async () => {
            const selected = findSelectedDetail();
            if (!selected) { 
                notify('danger', 'Vui lòng chọn độ dài và độ cứng có hàng.');
                return;
            }
            const qty = Math.max(1, parseInt(document.getElementById('qty').value || '1'));
            if (qty > Number(selected.stock)) {
                notify('warning', `Số lượng vượt quá tồn kho (${selected.stock}). Vui lòng giảm số lượng hoặc liên hệ shop.`);
                return;
            }
            const data = new URLSearchParams();
            data.append('productDetailId', selected.id);
            data.append('quantity', qty);
            try {
                const res = await fetch('/Cart/Add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data.toString(),
                    credentials: 'same-origin'
                });
                const loginUrl = `/Account/Login?msg=login_required&returnUrl=${encodeURIComponent(location.pathname + location.search)}`;
                // Not authenticated or redirected to login
                if (res.status === 401 || res.status === 403 || (res.redirected && res.url.includes('/Account/Login'))) {
                    window.location.href = loginUrl;
                    return;
                }
                if (res.ok) {
                    // Server redirects to CartDetail; follow it
                    window.location.href = res.url || '/CartDetail';
                } else {
                    notify('danger', 'Không thể thêm vào giỏ hàng. Vui lòng thử lại.');
                }
            } catch (e) {
                notify('danger', 'Có lỗi xảy ra khi thêm vào giỏ hàng.');
            }
        });

        // Buy Now: attempts to add to cart then redirects user to cart/checkout.
        document.getElementById('buy-now').addEventListener('click', async () => {
            const selected = findSelectedDetail();
            if (!selected) {
                notify('danger', 'Vui lòng chọn độ dài và độ cứng có hàng.');
                return;
            }
            const qty = Math.max(1, parseInt(document.getElementById('qty').value || '1'));
            if (qty > Number(selected.stock)) {
                notify('warning', `Số lượng vượt quá tồn kho (${selected.stock}). Vui lòng giảm số lượng hoặc liên hệ shop.`);
                return;
            }
            const data = new URLSearchParams();
            data.append('productDetailId', selected.id);
            data.append('quantity', qty);
            try {
                const res = await fetch('/Cart/Add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data.toString(),
                    credentials: 'same-origin'
                });
                const loginUrl = `/Account/Login?msg=login_required&returnUrl=${encodeURIComponent(location.pathname + location.search)}`;
                if (res.status === 401 || res.status === 403 || (res.redirected && res.url.includes('/Account/Login'))) {
                    window.location.href = loginUrl;
                    return;
                }
                if (res.ok) {
                    window.location.href = res.url || '/CartDetail';
                } else {
                    notify('danger', 'Không thể mua ngay lúc này. Vui lòng thử lại.');
                }
            } catch (e) {
                notify('danger', 'Có lỗi xảy ra khi mua ngay.');
            }
        });
    }

    // Toast helper
    function notify(type, message) {
        const toast = document.getElementById('pd-toast');
        const body = document.getElementById('pd-toast-body');
        body.textContent = message;
        toast.className = `toast align-items-center text-white border-0 bg-${type}`;
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }
</script>
}
