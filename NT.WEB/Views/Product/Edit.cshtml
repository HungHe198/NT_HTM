@model NT.SHARED.Models.Product
@using NT.SHARED.Constants

@{
    ViewBag.Title = "Sửa sản phẩm";
}

<h1>Sửa sản phẩm</h1>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="Id" />
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="form-group">
        <label asp-for="BrandId">Thương hiệu</label>
        <select asp-for="BrandId" class="form-control" asp-items="ViewBag.BrandSelectList">
            <option value="">-- Chọn thương hiệu --</option>
        </select>
        <span asp-validation-for="BrandId" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="ProductCode">Mã sản phẩm</label>
        <input asp-for="ProductCode" class="form-control" data-val-remote="Mã sản phẩm đã tồn tại" data-val-remote-url="@Url.Action("IsProductCodeAvailable", "Product", new { id = Model.Id })" />
        <span asp-validation-for="ProductCode" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="Name">Tên sản phẩm</label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="ShortDescription">Mô tả ngắn</label>
        <textarea asp-for="ShortDescription" class="form-control"></textarea>
        <span asp-validation-for="ShortDescription" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="Description">Mô tả chi tiết</label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="Thumbnail">Ảnh đại diện</label>
        <div class="mb-2">
            <input type="file" id="thumbnail-file" accept="image/*" class="form-control" />
        </div>
        <div class="mb-2">
            <img id="thumbnail-preview" src="@(Model.Thumbnail ?? "")" alt="preview" style="max-height:160px; @(string.IsNullOrWhiteSpace(Model.Thumbnail) ? "display:none;" : "") object-fit:contain;" />
        </div>
        <input asp-for="Thumbnail" id="Thumbnail" class="form-control" readonly />
        <span asp-validation-for="Thumbnail" class="text-danger"></span>
        <small class="form-text text-muted">Chọn ảnh mới để thay đổi ảnh đại diện.</small>
    </div>
    <div class="form-group">
        <label asp-for="Status">Trạng thái</label>
        <select asp-for="Status" class="form-control">
            <option value="@ProductStatus.Active" selected="@(Model.Status == ProductStatus.Active)">@ProductStatus.GetDisplayName(ProductStatus.Active)</option>
            <option value="@ProductStatus.Inactive" selected="@(Model.Status == ProductStatus.Inactive)">@ProductStatus.GetDisplayName(ProductStatus.Inactive)</option>
        </select>
        <span asp-validation-for="Status" class="text-danger"></span>
    </div>
    <button type="submit" class="btn btn-primary">Lưu</button>
    <a asp-action="Index" class="btn btn-secondary">Hủy</a>
</form>

<script>
    (function(){
        const fileInput = document.getElementById('thumbnail-file');
        const preview = document.getElementById('thumbnail-preview');
        const thumbnailInput = document.getElementById('Thumbnail');

        fileInput.addEventListener('change', async function(){
            const f = this.files && this.files[0];
            if(!f) return;

            // Preview ảnh
            const url = URL.createObjectURL(f);
            preview.src = url;
            preview.style.display = 'inline-block';

            // Upload ảnh lên server
            const data = new FormData();
            data.append('file', f);
            try {
                const res = await fetch('/ProductImage/Upload', { method: 'POST', body: data });
                if(!res.ok) {
                    alert('Tải ảnh thất bại');
                    return;
                }
                const json = await res.json();
                thumbnailInput.value = json.url || '';
            } catch(e) {
                alert('Có lỗi khi tải ảnh: ' + e.message);
            }
        });
    })();
</script>

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
}
